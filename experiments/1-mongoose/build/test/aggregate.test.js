"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const consola_1 = __importDefault(require("consola"));
const mongoose_1 = __importDefault(require("mongoose"));
const mongodb_memory_server_1 = require("mongodb-memory-server");
require("chai").should();
const chai_1 = require("chai");
describe("aggregate", function () {
    describe("tx with transfers", function () {
        let Tx;
        const TxSchema = new mongoose_1.default.Schema({
            slippage: { type: Number, index: true },
            transfers: [{ from: String, usd: Number }],
            dexes: [String],
        });
        before(async function () {
            const mongod = new mongodb_memory_server_1.MongoMemoryServer();
            const uri = await mongod.getUri();
            const mongoOpts = {
                useNewUrlParser: true,
                useUnifiedTopology: true,
                useFindAndModify: false,
                useCreateIndex: true,
            };
            const connection = await mongoose_1.default.createConnection(uri, mongoOpts);
            Tx = connection.model("Tx", TxSchema);
        });
        it("should create tx without transfers", async function () {
            const tx = await Tx.create({});
            chai_1.assert.lengthOf(tx.transfers, 0);
        });
        it("should create tx with transfers", async function () {
            const tx = await Tx.create({
                transfers: [
                    { from: "a", usd: 1 },
                    { from: "b", usd: 2 },
                ],
            });
            chai_1.assert.lengthOf(tx.transfers, 2);
        });
        it("push() should add new transfers to the end", async function () {
            let tx = await Tx.create({
                transfers: [{ from: "a", usd: 1 }],
            });
            tx.transfers.push({ from: "b", usd: 2 });
            await tx.save();
            tx = await Tx.findById(tx.id);
            chai_1.assert.lengthOf(tx.transfers, 2);
            tx.transfers[0].from.should.equal("a");
            tx.transfers[1].from.should.equal("b");
        });
        it("unshift() should add new transfers to the end", async function () {
            let tx = await Tx.create({
                transfers: [{ from: "a", usd: 1 }],
            });
            tx.transfers.unshift({ from: "b", usd: 2 });
            await tx.save();
            tx = await Tx.findById(tx.id);
            chai_1.assert.lengthOf(tx.transfers, 2);
            tx.transfers[0].from.should.equal("b");
            tx.transfers[1].from.should.equal("a");
        });
        it("addToSet() should distinct primitives", async function () {
            let tx = await Tx.create({
                dexes: ["dex1"],
            });
            tx.dexes.addToSet("dex1");
            await tx.save();
            tx = await Tx.findById(tx.id);
            chai_1.assert.lengthOf(tx.dexes, 1);
        });
        it("addToSet() should not distinct objects with props", async function () {
            let tx = await Tx.create({
                transfers: [{ from: "a", usd: 1 }],
            });
            tx.transfers.addToSet({ from: "a", usd: 2 });
            tx.transfers.addToSet({ from: "a", usd: 2 });
            await tx.save();
            tx = await Tx.findById(tx.id);
            chai_1.assert.lengthOf(tx.transfers, 3);
        });
        it("indexOf() should find primitive", async function () {
            let tx = await Tx.create({
                dexes: ["dex1", "dex2"],
            });
            const index = tx.dexes.indexOf("dex2");
            index.should.equal(1);
        });
        it("indexOf() should not find object with props", async function () {
            let tx = await Tx.create({
                transfers: [
                    { from: "a", usd: 1 },
                    { from: "a", usd: 2 },
                ],
            });
            const index = tx.transfers.indexOf({ from: "a", usd: 1 });
            index.should.equal(-1);
        });
        it("findOneAndUpdate should rewrite doc with array of subdoc", async function () {
            let tx = await Tx.create({
                transfers: [{ from: "a", usd: 1 }],
            });
            consola_1.default.info(tx);
            tx = await Tx.findOneAndUpdate({ _id: tx.id }, {
                transfers: [
                    { from: "a", usd: 1 },
                    { from: "b", usd: 2 },
                ],
            }, { new: true });
            consola_1.default.info(tx);
            chai_1.assert.lengthOf(tx.transfers, 2);
        });
        it("should aggregate like a pro", async function () {
            await Tx.deleteMany();
            await Tx.create({
                slippage: 20,
                transfers: [
                    { from: "a", usd: 1 },
                    { from: "a", usd: 2 },
                ],
            });
            await Tx.create({
                slippage: 10,
                transfers: [
                    { from: "a", usd: 1 },
                    { from: "b", usd: 2 },
                    { from: "c", usd: 3 },
                ],
            });
            await Tx.create({
                slippage: 30,
                transfers: [
                    { from: "b", usd: 1 },
                    { from: "a", usd: 2 },
                ],
            });
            const aggr = await Tx.aggregate()
                .match({ slippage: { $gte: 20 } })
                .unwind("transfers")
                .group({ _id: "$transfers.from", usd: { $sum: "$transfers.usd" } })
                .sort({ usd: -1 });
            chai_1.assert.lengthOf(aggr, 2);
            aggr[0].should.deep.equal({ _id: "a", usd: 5 });
            aggr[1].should.deep.equal({ _id: "b", usd: 1 });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWdncmVnYXRlLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi90ZXN0L2FnZ3JlZ2F0ZS50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsc0RBQThCO0FBQzlCLHdEQUFnQztBQUNoQyxpRUFBMEQ7QUFFMUQsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ3pCLCtCQUE4QjtBQUs5QixRQUFRLENBQUMsV0FBVyxFQUFFO0lBQ3BCLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRTtRQUM1QixJQUFJLEVBQU8sQ0FBQztRQUNaLE1BQU0sUUFBUSxHQUFHLElBQUksa0JBQVEsQ0FBQyxNQUFNLENBQUM7WUFDbkMsUUFBUSxFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFO1lBQ3ZDLFNBQVMsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLENBQUM7WUFDMUMsS0FBSyxFQUFFLENBQUMsTUFBTSxDQUFDO1NBQ2hCLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxLQUFLO1lBQ1YsTUFBTSxNQUFNLEdBQUcsSUFBSSx5Q0FBaUIsRUFBRSxDQUFDO1lBRXZDLE1BQU0sR0FBRyxHQUFHLE1BQU0sTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ2xDLE1BQU0sU0FBUyxHQUFHO2dCQUNoQixlQUFlLEVBQUUsSUFBSTtnQkFDckIsa0JBQWtCLEVBQUUsSUFBSTtnQkFDeEIsZ0JBQWdCLEVBQUUsS0FBSztnQkFDdkIsY0FBYyxFQUFFLElBQUk7YUFDckIsQ0FBQztZQUVGLE1BQU0sVUFBVSxHQUFHLE1BQU0sa0JBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDbkUsRUFBRSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3hD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RSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUU7aUJBQ3RCO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsTUFBTSxJQUFJLEdBQUcsTUFBTSxFQUFFLENBQUMsU0FBUyxFQUFFO2lCQUM5QixLQUFLLENBQUMsRUFBRSxRQUFRLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQztpQkFDakMsTUFBTSxDQUFDLFdBQVcsQ0FBQztpQkFDbkIsS0FBSyxDQUFDLEVBQUUsR0FBRyxFQUFFLGlCQUFpQixFQUFFLEdBQUcsRUFBRSxFQUFFLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxFQUFFLENBQUM7aUJBQ2xFLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFckIsYUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDekIsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNoRCxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBR2xELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjb25zb2xhIGZyb20gXCJjb25zb2xhXCI7XG5pbXBvcnQgbW9uZ29vc2UgZnJvbSBcIm1vbmdvb3NlXCI7XG5pbXBvcnQgeyBNb25nb01lbW9yeVNlcnZlciB9IGZyb20gXCJtb25nb2RiLW1lbW9yeS1zZXJ2ZXJcIjtcblxucmVxdWlyZShcImNoYWlcIikuc2hvdWxkKCk7XG5pbXBvcnQgeyBhc3NlcnQgfSBmcm9tIFwiY2hhaVwiO1xuLy8gY29uc29sYS5pbmZvKGFzc2VydCk7XG5cbmltcG9ydCB7IEEgfSBmcm9tIFwiLi4vc3JjXCI7XG5cbmRlc2NyaWJlKFwiYWdncmVnYXRlXCIsIGZ1bmN0aW9uICgpIHtcbiAgZGVzY3JpYmUoXCJ0eCB3aXRoIHRyYW5zZmVyc1wiLCBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IFR4OiBhbnk7XG4gICAgY29uc3QgVHhTY2hlbWEgPSBuZXcgbW9uZ29vc2UuU2NoZW1hKHtcbiAgICAgIHNsaXBwYWdlOiB7IHR5cGU6IE51bWJlciwgaW5kZXg6IHRydWUgfSxcbiAgICAgIHRyYW5zZmVyczogW3sgZnJvbTogU3RyaW5nLCB1c2Q6IE51bWJlciB9XSxcbiAgICAgIGRleGVzOiBbU3RyaW5nXSxcbiAgICB9KTtcblxuICAgIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCBtb25nb2QgPSBuZXcgTW9uZ29NZW1vcnlTZXJ2ZXIoKTtcblxuICAgICAgY29uc3QgdXJpID0gYXdhaXQgbW9uZ29kLmdldFVyaSgpO1xuICAgICAgY29uc3QgbW9uZ29PcHRzID0ge1xuICAgICAgICB1c2VOZXdVcmxQYXJzZXI6IHRydWUsXG4gICAgICAgIHVzZVVuaWZpZWRUb3BvbG9neTogdHJ1ZSxcbiAgICAgICAgdXNlRmluZEFuZE1vZGlmeTogZmFsc2UsXG4gICAgICAgIHVzZUNyZWF0ZUluZGV4OiB0cnVlLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IG1vbmdvb3NlLmNyZWF0ZUNvbm5lY3Rpb24odXJpLCBtb25nb09wdHMpO1xuICAgICAgVHggPSBjb25uZWN0aW9uLm1vZGVsKFwiVHhcIiwgVHhTY2hlbWEpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgY3JlYXRlIHR4IHdpdGhvdXQgdHJhbnNmZXJzXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnN0IHR4ID0gYXdhaXQgVHguY3JlYXRlKHt9KTtcblxuICAgICAgYXNzZXJ0Lmxlbmd0aE9mKHR4LnRyYW5zZmVycywgMCk7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCBjcmVhdGUgdHggd2l0aCB0cmFuc2ZlcnNcIiwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3QgdHggPSBhd2FpdCBUeC5jcmVhdGUoe1xuICAgICAgICB0cmFuc2ZlcnM6IFtcbiAgICAgICAgICB7IGZyb206IFwiYVwiLCB1c2Q6IDEgfSxcbiAgICAgICAgICB7IGZyb206IFwiYlwiLCB1c2Q6IDIgfSxcbiAgICAgICAgXSxcbiAgICAgIH0pO1xuXG4gICAgICBhc3NlcnQubGVuZ3RoT2YodHgudHJhbnNmZXJzLCAyKTtcbiAgICB9KTtcblxuICAgIGl0KFwicHVzaCgpIHNob3VsZCBhZGQgbmV3IHRyYW5zZmVycyB0byB0aGUgZW5kXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCB0eCA9IGF3YWl0IFR4LmNyZWF0ZSh7XG4gICAgICAgIHRyYW5zZmVyczogW3sgZnJvbTogXCJhXCIsIHVzZDogMSB9XSxcbiAgICAgIH0pO1xuXG4gICAgICB0eC50cmFuc2ZlcnMucHVzaCh7IGZyb206IFwiYlwiLCB1c2Q6IDIgfSk7XG4gICAgICBhd2FpdCB0eC5zYXZlKCk7XG4gICAgICB0eCA9IGF3YWl0IFR4LmZpbmRCeUlkKHR4LmlkKTtcbiAgICAgIGFzc2VydC5sZW5ndGhPZih0eC50cmFuc2ZlcnMsIDIpO1xuICAgICAgdHgudHJhbnNmZXJzWzBdLmZyb20uc2hvdWxkLmVxdWFsKFwiYVwiKTtcbiAgICAgIHR4LnRyYW5zZmVyc1sxXS5mcm9tLnNob3VsZC5lcXVhbChcImJcIik7XG4gICAgfSk7XG5cbiAgICBpdChcInVuc2hpZnQoKSBzaG91bGQgYWRkIG5ldyB0cmFuc2ZlcnMgdG8gdGhlIGVuZFwiLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgdHggPSBhd2FpdCBUeC5jcmVhdGUoe1xuICAgICAgICB0cmFuc2ZlcnM6IFt7IGZyb206IFwiYVwiLCB1c2Q6IDEgfV0sXG4gICAgICB9KTtcblxuICAgICAgdHgudHJhbnNmZXJzLnVuc2hpZnQoeyBmcm9tOiBcImJcIiwgdXNkOiAyIH0pO1xuICAgICAgYXdhaXQgdHguc2F2ZSgpO1xuICAgICAgdHggPSBhd2FpdCBUeC5maW5kQnlJZCh0eC5pZCk7XG4gICAgICBhc3NlcnQubGVuZ3RoT2YodHgudHJhbnNmZXJzLCAyKTtcbiAgICAgIHR4LnRyYW5zZmVyc1swXS5mcm9tLnNob3VsZC5lcXVhbChcImJcIik7XG4gICAgICB0eC50cmFuc2ZlcnNbMV0uZnJvbS5zaG91bGQuZXF1YWwoXCJhXCIpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJhZGRUb1NldCgpIHNob3VsZCBkaXN0aW5jdCBwcmltaXRpdmVzXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCB0eCA9IGF3YWl0IFR4LmNyZWF0ZSh7XG4gICAgICAgIGRleGVzOiBbXCJkZXgxXCJdLFxuICAgICAgfSk7XG5cbiAgICAgIHR4LmRleGVzLmFkZFRvU2V0KFwiZGV4MVwiKTtcbiAgICAgIGF3YWl0IHR4LnNhdmUoKTtcbiAgICAgIHR4ID0gYXdhaXQgVHguZmluZEJ5SWQodHguaWQpO1xuICAgICAgYXNzZXJ0Lmxlbmd0aE9mKHR4LmRleGVzLCAxKTtcbiAgICB9KTtcblxuICAgIGl0KFwiYWRkVG9TZXQoKSBzaG91bGQgbm90IGRpc3RpbmN0IG9iamVjdHMgd2l0aCBwcm9wc1wiLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgdHggPSBhd2FpdCBUeC5jcmVhdGUoe1xuICAgICAgICB0cmFuc2ZlcnM6IFt7IGZyb206IFwiYVwiLCB1c2Q6IDEgfV0sXG4gICAgICB9KTtcblxuICAgICAgdHgudHJhbnNmZXJzLmFkZFRvU2V0KHsgZnJvbTogXCJhXCIsIHVzZDogMiB9KTtcbiAgICAgIHR4LnRyYW5zZmVycy5hZGRUb1NldCh7IGZyb206IFwiYVwiLCB1c2Q6IDIgfSk7XG4gICAgICBhd2FpdCB0eC5zYXZlKCk7XG4gICAgICB0eCA9IGF3YWl0IFR4LmZpbmRCeUlkKHR4LmlkKTtcbiAgICAgIGFzc2VydC5sZW5ndGhPZih0eC50cmFuc2ZlcnMsIDMpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJpbmRleE9mKCkgc2hvdWxkIGZpbmQgcHJpbWl0aXZlXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCB0eCA9IGF3YWl0IFR4LmNyZWF0ZSh7XG4gICAgICAgIGRleGVzOiBbXCJkZXgxXCIsIFwiZGV4MlwiXSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBpbmRleCA9IHR4LmRleGVzLmluZGV4T2YoXCJkZXgyXCIpO1xuICAgICAgaW5kZXguc2hvdWxkLmVxdWFsKDEpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJpbmRleE9mKCkgc2hvdWxkIG5vdCBmaW5kIG9iamVjdCB3aXRoIHByb3BzXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCB0eCA9IGF3YWl0IFR4LmNyZWF0ZSh7XG4gICAgICAgIHRyYW5zZmVyczogW1xuICAgICAgICAgIHsgZnJvbTogXCJhXCIsIHVzZDogMSB9LFxuICAgICAgICAgIHsgZnJvbTogXCJhXCIsIHVzZDogMiB9LFxuICAgICAgICBdLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGluZGV4ID0gdHgudHJhbnNmZXJzLmluZGV4T2YoeyBmcm9tOiBcImFcIiwgdXNkOiAxIH0pO1xuICAgICAgaW5kZXguc2hvdWxkLmVxdWFsKC0xKTtcbiAgICB9KTtcblxuICAgIGl0KFwiZmluZE9uZUFuZFVwZGF0ZSBzaG91bGQgcmV3cml0ZSBkb2Mgd2l0aCBhcnJheSBvZiBzdWJkb2NcIiwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHR4ID0gYXdhaXQgVHguY3JlYXRlKHtcbiAgICAgICAgdHJhbnNmZXJzOiBbeyBmcm9tOiBcImFcIiwgdXNkOiAxIH1dLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnNvbGEuaW5mbyh0eCk7XG5cbiAgICAgIHR4ID0gYXdhaXQgVHguZmluZE9uZUFuZFVwZGF0ZShcbiAgICAgICAgeyBfaWQ6IHR4LmlkIH0sXG4gICAgICAgIHtcbiAgICAgICAgICB0cmFuc2ZlcnM6IFtcbiAgICAgICAgICAgIHsgZnJvbTogXCJhXCIsIHVzZDogMSB9LFxuICAgICAgICAgICAgeyBmcm9tOiBcImJcIiwgdXNkOiAyIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAgeyBuZXc6IHRydWUgfVxuICAgICAgKTtcbiAgICAgIGNvbnNvbGEuaW5mbyh0eCk7XG4gICAgICBhc3NlcnQubGVuZ3RoT2YodHgudHJhbnNmZXJzLCAyKTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIGFnZ3JlZ2F0ZSBsaWtlIGEgcHJvXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGF3YWl0IFR4LmRlbGV0ZU1hbnkoKTtcblxuICAgICAgYXdhaXQgVHguY3JlYXRlKHtcbiAgICAgICAgc2xpcHBhZ2U6IDIwLFxuICAgICAgICB0cmFuc2ZlcnM6IFtcbiAgICAgICAgICB7IGZyb206IFwiYVwiLCB1c2Q6IDEgfSxcbiAgICAgICAgICB7IGZyb206IFwiYVwiLCB1c2Q6IDIgfSxcbiAgICAgICAgXSxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBUeC5jcmVhdGUoe1xuICAgICAgICBzbGlwcGFnZTogMTAsXG4gICAgICAgIHRyYW5zZmVyczogW1xuICAgICAgICAgIHsgZnJvbTogXCJhXCIsIHVzZDogMSB9LFxuICAgICAgICAgIHsgZnJvbTogXCJiXCIsIHVzZDogMiB9LFxuICAgICAgICAgIHsgZnJvbTogXCJjXCIsIHVzZDogMyB9LFxuICAgICAgICBdLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IFR4LmNyZWF0ZSh7XG4gICAgICAgIHNsaXBwYWdlOiAzMCxcbiAgICAgICAgdHJhbnNmZXJzOiBbXG4gICAgICAgICAgeyBmcm9tOiBcImJcIiwgdXNkOiAxIH0sXG4gICAgICAgICAgeyBmcm9tOiBcImFcIiwgdXNkOiAyIH0sXG4gICAgICAgIF0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgYWdnciA9IGF3YWl0IFR4LmFnZ3JlZ2F0ZSgpXG4gICAgICAgIC5tYXRjaCh7IHNsaXBwYWdlOiB7ICRndGU6IDIwIH0gfSlcbiAgICAgICAgLnVud2luZChcInRyYW5zZmVyc1wiKVxuICAgICAgICAuZ3JvdXAoeyBfaWQ6IFwiJHRyYW5zZmVycy5mcm9tXCIsIHVzZDogeyAkc3VtOiBcIiR0cmFuc2ZlcnMudXNkXCIgfSB9KVxuICAgICAgICAuc29ydCh7IHVzZDogLTEgfSk7XG5cbiAgICAgIGFzc2VydC5sZW5ndGhPZihhZ2dyLCAyKTtcbiAgICAgIGFnZ3JbMF0uc2hvdWxkLmRlZXAuZXF1YWwoeyBfaWQ6IFwiYVwiLCB1c2Q6IDUgfSk7XG4gICAgICBhZ2dyWzFdLnNob3VsZC5kZWVwLmVxdWFsKHsgX2lkOiBcImJcIiwgdXNkOiAxIH0pO1xuXG4gICAgICAvLyBjb25zb2xhLmluZm8oYWdncik7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=