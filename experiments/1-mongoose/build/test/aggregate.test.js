"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const mongoose_1 = __importDefault(require("mongoose"));
const mongodb_memory_server_1 = require("mongodb-memory-server");
require("chai").should();
const chai_1 = require("chai");
describe("aggregate", function () {
    describe("tx with transfers", function () {
        let Tx;
        const TxSchema = new mongoose_1.default.Schema({
            slippage: { type: Number, index: true },
            transfers: [{ from: String, usd: Number }],
            dexes: [String],
        });
        before(async function () {
            const mongod = new mongodb_memory_server_1.MongoMemoryServer();
            const uri = await mongod.getUri();
            const mongoOpts = {
                useNewUrlParser: true,
                useUnifiedTopology: true,
                useFindAndModify: false,
                useCreateIndex: true,
            };
            const connection = await mongoose_1.default.createConnection(uri, mongoOpts);
            Tx = connection.model("Tx", TxSchema);
        });
        it("should create tx without transfers", async function () {
            const tx = await Tx.create({});
            chai_1.assert.lengthOf(tx.transfers, 0);
        });
        it("should create tx with transfers", async function () {
            const tx = await Tx.create({
                transfers: [
                    { from: "a", usd: 1 },
                    { from: "b", usd: 2 },
                ],
            });
            chai_1.assert.lengthOf(tx.transfers, 2);
        });
        it("push() should add new transfers to the end", async function () {
            let tx = await Tx.create({
                transfers: [{ from: "a", usd: 1 }],
            });
            tx.transfers.push({ from: "b", usd: 2 });
            await tx.save();
            tx = await Tx.findById(tx.id);
            chai_1.assert.lengthOf(tx.transfers, 2);
            tx.transfers[0].from.should.equal("a");
            tx.transfers[1].from.should.equal("b");
        });
        it("unshift() should add new transfers to the end", async function () {
            let tx = await Tx.create({
                transfers: [{ from: "a", usd: 1 }],
            });
            tx.transfers.unshift({ from: "b", usd: 2 });
            await tx.save();
            tx = await Tx.findById(tx.id);
            chai_1.assert.lengthOf(tx.transfers, 2);
            tx.transfers[0].from.should.equal("b");
            tx.transfers[1].from.should.equal("a");
        });
        it("addToSet() should distinct primitives", async function () {
            let tx = await Tx.create({
                dexes: ["dex1"],
            });
            tx.dexes.addToSet("dex1");
            await tx.save();
            tx = await Tx.findById(tx.id);
            chai_1.assert.lengthOf(tx.dexes, 1);
        });
        it("addToSet() should not distinct objects with props", async function () {
            let tx = await Tx.create({
                transfers: [{ from: "a", usd: 1 }],
            });
            tx.transfers.addToSet({ from: "a", usd: 2 });
            tx.transfers.addToSet({ from: "a", usd: 2 });
            await tx.save();
            tx = await Tx.findById(tx.id);
            chai_1.assert.lengthOf(tx.transfers, 3);
        });
        it("indexOf() should find primitive", async function () {
            let tx = await Tx.create({
                dexes: ["dex1", "dex2"],
            });
            const index = tx.dexes.indexOf("dex2");
            index.should.equal(1);
        });
        it("indexOf() should not find object with props", async function () {
            let tx = await Tx.create({
                transfers: [
                    { from: "a", usd: 1 },
                    { from: "a", usd: 2 },
                ],
            });
            const index = tx.transfers.indexOf({ from: "a", usd: 1 });
            index.should.equal(-1);
        });
        it("findOneAndUpdate should rewrite doc with array of subdoc", async function () {
            let tx = await Tx.create({
                transfers: [{ from: "a", usd: 1 }],
            });
            tx = await Tx.findOneAndUpdate({ _id: tx.id }, {
                transfers: [
                    { from: "a", usd: 1 },
                    { from: "b", usd: 2 },
                ],
            }, { new: true });
            chai_1.assert.lengthOf(tx.transfers, 2);
        });
        it("should aggregate like a pro", async function () {
            await Tx.deleteMany();
            await Tx.create({
                slippage: 20,
                transfers: [
                    { from: "a", usd: 1 },
                    { from: "a", usd: 2 },
                ],
            });
            await Tx.create({
                slippage: 10,
                transfers: [
                    { from: "a", usd: 1 },
                    { from: "b", usd: 2 },
                    { from: "c", usd: 3 },
                ],
            });
            await Tx.create({
                slippage: 30,
                transfers: [
                    { from: "b", usd: 1 },
                    { from: "a", usd: 2 },
                ],
            });
            const aggr = await Tx.aggregate()
                .match({ slippage: { $gte: 20 } })
                .unwind("transfers")
                .group({ _id: "$transfers.from", usd: { $sum: "$transfers.usd" } })
                .sort({ usd: -1 });
            chai_1.assert.lengthOf(aggr, 2);
            aggr[0].should.deep.equal({ _id: "a", usd: 5 });
            aggr[1].should.deep.equal({ _id: "b", usd: 1 });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWdncmVnYXRlLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi90ZXN0L2FnZ3JlZ2F0ZS50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0Esd0RBQWdDO0FBQ2hDLGlFQUEwRDtBQUUxRCxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDekIsK0JBQThCO0FBSzlCLFFBQVEsQ0FBQyxXQUFXLEVBQUU7SUFDcEIsUUFBUSxDQUFDLG1CQUFtQixFQUFFO1FBQzVCLElBQUksRUFBTyxDQUFDO1FBQ1osTUFBTSxRQUFRLEdBQUcsSUFBSSxrQkFBUSxDQUFDLE1BQU0sQ0FBQztZQUNuQyxRQUFRLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUU7WUFDdkMsU0FBUyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsQ0FBQztZQUMxQyxLQUFLLEVBQUUsQ0FBQyxNQUFNLENBQUM7U0FDaEIsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLEtBQUs7WUFDVixNQUFNLE1BQU0sR0FBRyxJQUFJLHlDQUFpQixFQUFFLENBQUM7WUFFdkMsTUFBTSxHQUFHLEdBQUcsTUFBTSxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDbEMsTUFBTSxTQUFTLEdBQUc7Z0JBQ2hCLGVBQWUsRUFBRSxJQUFJO2dCQUNyQixrQkFBa0IsRUFBRSxJQUFJO2dCQUN4QixnQkFBZ0IsRUFBRSxLQUFLO2dCQUN2QixjQUFjLEVBQUUsSUFBSTthQUNyQixDQUFDO1lBRUYsTUFBTSxVQUFVLEdBQUcsTUFBTSxrQkFBUSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUNuRSxFQUFFLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENB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QyxTQUFTLEVBQUU7aUJBQzlCLEtBQUssQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDO2lCQUNqQyxNQUFNLENBQUMsV0FBVyxDQUFDO2lCQUNuQixLQUFLLENBQUMsRUFBRSxHQUFHLEVBQUUsaUJBQWlCLEVBQUUsR0FBRyxFQUFFLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLEVBQUUsQ0FBQztpQkFDbEUsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUVyQixhQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN6QixJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2hELElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFHbEQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNvbnNvbGEgZnJvbSBcImNvbnNvbGFcIjtcbmltcG9ydCBtb25nb29zZSBmcm9tIFwibW9uZ29vc2VcIjtcbmltcG9ydCB7IE1vbmdvTWVtb3J5U2VydmVyIH0gZnJvbSBcIm1vbmdvZGItbWVtb3J5LXNlcnZlclwiO1xuXG5yZXF1aXJlKFwiY2hhaVwiKS5zaG91bGQoKTtcbmltcG9ydCB7IGFzc2VydCB9IGZyb20gXCJjaGFpXCI7XG4vLyBjb25zb2xhLmluZm8oYXNzZXJ0KTtcblxuaW1wb3J0IHsgQSB9IGZyb20gXCIuLi9zcmNcIjtcblxuZGVzY3JpYmUoXCJhZ2dyZWdhdGVcIiwgZnVuY3Rpb24gKCkge1xuICBkZXNjcmliZShcInR4IHdpdGggdHJhbnNmZXJzXCIsIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgVHg6IGFueTtcbiAgICBjb25zdCBUeFNjaGVtYSA9IG5ldyBtb25nb29zZS5TY2hlbWEoe1xuICAgICAgc2xpcHBhZ2U6IHsgdHlwZTogTnVtYmVyLCBpbmRleDogdHJ1ZSB9LFxuICAgICAgdHJhbnNmZXJzOiBbeyBmcm9tOiBTdHJpbmcsIHVzZDogTnVtYmVyIH1dLFxuICAgICAgZGV4ZXM6IFtTdHJpbmddLFxuICAgIH0pO1xuXG4gICAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnN0IG1vbmdvZCA9IG5ldyBNb25nb01lbW9yeVNlcnZlcigpO1xuXG4gICAgICBjb25zdCB1cmkgPSBhd2FpdCBtb25nb2QuZ2V0VXJpKCk7XG4gICAgICBjb25zdCBtb25nb09wdHMgPSB7XG4gICAgICAgIHVzZU5ld1VybFBhcnNlcjogdHJ1ZSxcbiAgICAgICAgdXNlVW5pZmllZFRvcG9sb2d5OiB0cnVlLFxuICAgICAgICB1c2VGaW5kQW5kTW9kaWZ5OiBmYWxzZSxcbiAgICAgICAgdXNlQ3JlYXRlSW5kZXg6IHRydWUsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBjb25uZWN0aW9uID0gYXdhaXQgbW9uZ29vc2UuY3JlYXRlQ29ubmVjdGlvbih1cmksIG1vbmdvT3B0cyk7XG4gICAgICBUeCA9IGNvbm5lY3Rpb24ubW9kZWwoXCJUeFwiLCBUeFNjaGVtYSk7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCBjcmVhdGUgdHggd2l0aG91dCB0cmFuc2ZlcnNcIiwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3QgdHggPSBhd2FpdCBUeC5jcmVhdGUoe30pO1xuXG4gICAgICBhc3NlcnQubGVuZ3RoT2YodHgudHJhbnNmZXJzLCAwKTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIGNyZWF0ZSB0eCB3aXRoIHRyYW5zZmVyc1wiLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCB0eCA9IGF3YWl0IFR4LmNyZWF0ZSh7XG4gICAgICAgIHRyYW5zZmVyczogW1xuICAgICAgICAgIHsgZnJvbTogXCJhXCIsIHVzZDogMSB9LFxuICAgICAgICAgIHsgZnJvbTogXCJiXCIsIHVzZDogMiB9LFxuICAgICAgICBdLFxuICAgICAgfSk7XG5cbiAgICAgIGFzc2VydC5sZW5ndGhPZih0eC50cmFuc2ZlcnMsIDIpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJwdXNoKCkgc2hvdWxkIGFkZCBuZXcgdHJhbnNmZXJzIHRvIHRoZSBlbmRcIiwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHR4ID0gYXdhaXQgVHguY3JlYXRlKHtcbiAgICAgICAgdHJhbnNmZXJzOiBbeyBmcm9tOiBcImFcIiwgdXNkOiAxIH1dLFxuICAgICAgfSk7XG5cbiAgICAgIHR4LnRyYW5zZmVycy5wdXNoKHsgZnJvbTogXCJiXCIsIHVzZDogMiB9KTtcbiAgICAgIGF3YWl0IHR4LnNhdmUoKTtcbiAgICAgIHR4ID0gYXdhaXQgVHguZmluZEJ5SWQodHguaWQpO1xuICAgICAgYXNzZXJ0Lmxlbmd0aE9mKHR4LnRyYW5zZmVycywgMik7XG4gICAgICB0eC50cmFuc2ZlcnNbMF0uZnJvbS5zaG91bGQuZXF1YWwoXCJhXCIpO1xuICAgICAgdHgudHJhbnNmZXJzWzFdLmZyb20uc2hvdWxkLmVxdWFsKFwiYlwiKTtcbiAgICB9KTtcblxuICAgIGl0KFwidW5zaGlmdCgpIHNob3VsZCBhZGQgbmV3IHRyYW5zZmVycyB0byB0aGUgZW5kXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCB0eCA9IGF3YWl0IFR4LmNyZWF0ZSh7XG4gICAgICAgIHRyYW5zZmVyczogW3sgZnJvbTogXCJhXCIsIHVzZDogMSB9XSxcbiAgICAgIH0pO1xuXG4gICAgICB0eC50cmFuc2ZlcnMudW5zaGlmdCh7IGZyb206IFwiYlwiLCB1c2Q6IDIgfSk7XG4gICAgICBhd2FpdCB0eC5zYXZlKCk7XG4gICAgICB0eCA9IGF3YWl0IFR4LmZpbmRCeUlkKHR4LmlkKTtcbiAgICAgIGFzc2VydC5sZW5ndGhPZih0eC50cmFuc2ZlcnMsIDIpO1xuICAgICAgdHgudHJhbnNmZXJzWzBdLmZyb20uc2hvdWxkLmVxdWFsKFwiYlwiKTtcbiAgICAgIHR4LnRyYW5zZmVyc1sxXS5mcm9tLnNob3VsZC5lcXVhbChcImFcIik7XG4gICAgfSk7XG5cbiAgICBpdChcImFkZFRvU2V0KCkgc2hvdWxkIGRpc3RpbmN0IHByaW1pdGl2ZXNcIiwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHR4ID0gYXdhaXQgVHguY3JlYXRlKHtcbiAgICAgICAgZGV4ZXM6IFtcImRleDFcIl0sXG4gICAgICB9KTtcblxuICAgICAgdHguZGV4ZXMuYWRkVG9TZXQoXCJkZXgxXCIpO1xuICAgICAgYXdhaXQgdHguc2F2ZSgpO1xuICAgICAgdHggPSBhd2FpdCBUeC5maW5kQnlJZCh0eC5pZCk7XG4gICAgICBhc3NlcnQubGVuZ3RoT2YodHguZGV4ZXMsIDEpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJhZGRUb1NldCgpIHNob3VsZCBub3QgZGlzdGluY3Qgb2JqZWN0cyB3aXRoIHByb3BzXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCB0eCA9IGF3YWl0IFR4LmNyZWF0ZSh7XG4gICAgICAgIHRyYW5zZmVyczogW3sgZnJvbTogXCJhXCIsIHVzZDogMSB9XSxcbiAgICAgIH0pO1xuXG4gICAgICB0eC50cmFuc2ZlcnMuYWRkVG9TZXQoeyBmcm9tOiBcImFcIiwgdXNkOiAyIH0pO1xuICAgICAgdHgudHJhbnNmZXJzLmFkZFRvU2V0KHsgZnJvbTogXCJhXCIsIHVzZDogMiB9KTtcbiAgICAgIGF3YWl0IHR4LnNhdmUoKTtcbiAgICAgIHR4ID0gYXdhaXQgVHguZmluZEJ5SWQodHguaWQpO1xuICAgICAgYXNzZXJ0Lmxlbmd0aE9mKHR4LnRyYW5zZmVycywgMyk7XG4gICAgfSk7XG5cbiAgICBpdChcImluZGV4T2YoKSBzaG91bGQgZmluZCBwcmltaXRpdmVcIiwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHR4ID0gYXdhaXQgVHguY3JlYXRlKHtcbiAgICAgICAgZGV4ZXM6IFtcImRleDFcIiwgXCJkZXgyXCJdLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGluZGV4ID0gdHguZGV4ZXMuaW5kZXhPZihcImRleDJcIik7XG4gICAgICBpbmRleC5zaG91bGQuZXF1YWwoMSk7XG4gICAgfSk7XG5cbiAgICBpdChcImluZGV4T2YoKSBzaG91bGQgbm90IGZpbmQgb2JqZWN0IHdpdGggcHJvcHNcIiwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHR4ID0gYXdhaXQgVHguY3JlYXRlKHtcbiAgICAgICAgdHJhbnNmZXJzOiBbXG4gICAgICAgICAgeyBmcm9tOiBcImFcIiwgdXNkOiAxIH0sXG4gICAgICAgICAgeyBmcm9tOiBcImFcIiwgdXNkOiAyIH0sXG4gICAgICAgIF0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgaW5kZXggPSB0eC50cmFuc2ZlcnMuaW5kZXhPZih7IGZyb206IFwiYVwiLCB1c2Q6IDEgfSk7XG4gICAgICBpbmRleC5zaG91bGQuZXF1YWwoLTEpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJmaW5kT25lQW5kVXBkYXRlIHNob3VsZCByZXdyaXRlIGRvYyB3aXRoIGFycmF5IG9mIHN1YmRvY1wiLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgdHggPSBhd2FpdCBUeC5jcmVhdGUoe1xuICAgICAgICB0cmFuc2ZlcnM6IFt7IGZyb206IFwiYVwiLCB1c2Q6IDEgfV0sXG4gICAgICB9KTtcblxuICAgICAgLy8gY29uc29sYS5pbmZvKHR4KTtcblxuICAgICAgdHggPSBhd2FpdCBUeC5maW5kT25lQW5kVXBkYXRlKFxuICAgICAgICB7IF9pZDogdHguaWQgfSxcbiAgICAgICAge1xuICAgICAgICAgIHRyYW5zZmVyczogW1xuICAgICAgICAgICAgeyBmcm9tOiBcImFcIiwgdXNkOiAxIH0sXG4gICAgICAgICAgICB7IGZyb206IFwiYlwiLCB1c2Q6IDIgfSxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgICB7IG5ldzogdHJ1ZSB9XG4gICAgICApO1xuICAgICAgLy8gY29uc29sYS5pbmZvKHR4KTtcbiAgICAgIGFzc2VydC5sZW5ndGhPZih0eC50cmFuc2ZlcnMsIDIpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgYWdncmVnYXRlIGxpa2UgYSBwcm9cIiwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgYXdhaXQgVHguZGVsZXRlTWFueSgpO1xuXG4gICAgICBhd2FpdCBUeC5jcmVhdGUoe1xuICAgICAgICBzbGlwcGFnZTogMjAsXG4gICAgICAgIHRyYW5zZmVyczogW1xuICAgICAgICAgIHsgZnJvbTogXCJhXCIsIHVzZDogMSB9LFxuICAgICAgICAgIHsgZnJvbTogXCJhXCIsIHVzZDogMiB9LFxuICAgICAgICBdLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IFR4LmNyZWF0ZSh7XG4gICAgICAgIHNsaXBwYWdlOiAxMCxcbiAgICAgICAgdHJhbnNmZXJzOiBbXG4gICAgICAgICAgeyBmcm9tOiBcImFcIiwgdXNkOiAxIH0sXG4gICAgICAgICAgeyBmcm9tOiBcImJcIiwgdXNkOiAyIH0sXG4gICAgICAgICAgeyBmcm9tOiBcImNcIiwgdXNkOiAzIH0sXG4gICAgICAgIF0sXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgVHguY3JlYXRlKHtcbiAgICAgICAgc2xpcHBhZ2U6IDMwLFxuICAgICAgICB0cmFuc2ZlcnM6IFtcbiAgICAgICAgICB7IGZyb206IFwiYlwiLCB1c2Q6IDEgfSxcbiAgICAgICAgICB7IGZyb206IFwiYVwiLCB1c2Q6IDIgfSxcbiAgICAgICAgXSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBhZ2dyID0gYXdhaXQgVHguYWdncmVnYXRlKClcbiAgICAgICAgLm1hdGNoKHsgc2xpcHBhZ2U6IHsgJGd0ZTogMjAgfSB9KVxuICAgICAgICAudW53aW5kKFwidHJhbnNmZXJzXCIpXG4gICAgICAgIC5ncm91cCh7IF9pZDogXCIkdHJhbnNmZXJzLmZyb21cIiwgdXNkOiB7ICRzdW06IFwiJHRyYW5zZmVycy51c2RcIiB9IH0pXG4gICAgICAgIC5zb3J0KHsgdXNkOiAtMSB9KTtcblxuICAgICAgYXNzZXJ0Lmxlbmd0aE9mKGFnZ3IsIDIpO1xuICAgICAgYWdnclswXS5zaG91bGQuZGVlcC5lcXVhbCh7IF9pZDogXCJhXCIsIHVzZDogNSB9KTtcbiAgICAgIGFnZ3JbMV0uc2hvdWxkLmRlZXAuZXF1YWwoeyBfaWQ6IFwiYlwiLCB1c2Q6IDEgfSk7XG5cbiAgICAgIC8vIGNvbnNvbGEuaW5mbyhhZ2dyKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==